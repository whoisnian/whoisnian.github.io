---
layout: post
title: æ•´ç†httpdæ—¥å¿—ä¸­çš„ä¿¡æ¯
categories: Server
---

> å› ä¸ºæ²¡æœ‰ä½¿ç”¨Google Analyticsä¸€ç±»çš„æµé‡ç»Ÿè®¡æœåŠ¡ï¼Œæ‰€ä»¥æˆ‘å¹¶ä¸æ¸…æ¥šè‡ªå·±åšå®¢çš„å…·ä½“è®¿é—®æƒ…å†µã€‚  
> ä½†æ˜¯ï¼Œé€šè¿‡å¦ä¸€é€”å¾„ä¹Ÿæ˜¯å¯ä»¥è·å–åˆ°åšå®¢è®¿é—®è®°å½•çš„ï¼Œé‚£å°±æ˜¯åˆ†æhttpdæ—¥å¿—ä¸­çš„ä¿¡æ¯ã€‚  

<!-- more -->

## å‡†å¤‡
* ä»æœåŠ¡å™¨ä¸Šä¸‹è½½æ—¥å¿—ã€‚  
  ç›´æ¥sftpåˆ°æŒ‡å®šçš„æ—¥å¿—æ–‡ä»¶å¤¹ä¸­æŠŠ`whoisnian.com-access_log`ä¸‹è½½ä¸‹æ¥å³å¯ã€‚  
* é€‰æ‹©è¦ä½¿ç”¨çš„å·¥å…·ã€‚  
  æƒ³é¡ºä¾¿ç†Ÿæ‚‰ä¸€ä¸‹SHELLæ“ä½œï¼Œå°±ç›´æ¥ç”¨Linuxçš„å„ç§å‘½ä»¤æ¥å¤„ç†äº†ã€‚  

## ç›®æ ‡  
å…ˆçœ‹çœ‹æ—¥å¿—é‡Œæœ‰ä»€ä¹ˆï¼š  
`10.10.10.10 - - [08/May/2019:17:17:33 +0800] "GET / HTTP/1.1" 200 9584`  
æˆ‘çš„æ—¥å¿—é‡Œæ¯ä¸€è¡Œéƒ½æ˜¯è¿™æ ·çš„æ ¼å¼ï¼Œåœ¨[Apacheå®˜æ–¹æ–‡æ¡£](https://httpd.apache.org/docs/current/mod/mod_log_config.html)ä¸­è¢«å«åš`Common Log Format (CLF)`ï¼Œå…·ä½“å«ä¹‰ä¸ºï¼š  
`è¿œç«¯ä¸»æœºåœ°å€ è¿œç«¯ç™»å½•å è¿œç¨‹ç”¨æˆ·å æ—¶é—´ è¯·æ±‚çš„ç¬¬ä¸€è¡Œ çŠ¶æ€ç  ä¼ é€çš„ä¸åŒ…å«HTTPå¤´çš„å­—èŠ‚æ•°`  
ä¹Ÿå°±æ˜¯è¯´ï¼Œä»æ—¥å¿—ä¸­å¯ä»¥è·å–åˆ°çš„æœ‰ç”¨ä¿¡æ¯åŒ…æ‹¬è®¿é—®è€…çš„IPï¼Œè®¿é—®æ—¶é—´ï¼Œè¯·æ±‚çš„å…·ä½“ç½‘å€ï¼Œè¯·æ±‚ç”¨çš„åè®®ï¼ŒæœåŠ¡å™¨å“åº”ç ã€‚æ‰€ä»¥ç»Ÿè®¡ä»¥ä¸‹å‡ ç‚¹æ˜¯å¯è¡Œçš„ï¼š  
* å•ä¸ªIPçš„è®¿é—®æ¬¡æ•°æ’è¡Œ
* å…·ä½“çš„ç½‘é¡µè®¿é—®é‡æ’è¡Œ
* è®¿é—®è€…IPåˆ†å¸ƒå›¾

å¯æƒœä¹‹å‰æœåŠ¡å™¨çš„ä¸€æ¬¡æ»šæŒ‚ï¼Œå¯¼è‡´æœåŠ¡å™¨ä¸Šçš„æ—¥å¿—åªæœ‰2018å¹´9æœˆä»½ä¹‹åçš„ï¼ŒçŒœæµ‹æœ€ç»ˆå¾—åˆ°çš„ç»“æœä¼šæ¯”è¾ƒå¯’ç¢œã€‚ğŸ˜­  

## ç­›é€‰
ç›´æ¥æ‰“å¼€æ—¥å¿—æ–‡ä»¶ï¼Œçº¦åå››ä¸‡è¡Œï¼Œä½†å¾ˆæ˜æ˜¾ï¼Œé‡Œé¢æœ‰è®¸å¤šæ— æ•ˆè¯·æ±‚ã€‚ä¾‹å¦‚ï¼š  
* `61.176.222.170 - - [20/Sep/2018:04:49:42 +0800] "GET http://47.99.121.32:39169/Ip/Up?Ip=45.77.221.110&Port=80&Check=30&Order=61.176.222.170 HTTP/1.1" 404 1010`  
* `193.112.137.18 - - [20/Sep/2018:06:17:47 +0800] "POST /cainiao.php HTTP/1.1" 404 16`  
* `221.231.6.240 - - [26/Sep/2018:03:32:52 +0800] "GET /Web/FCKeditor/fckeditor.js HTTP/1.1" 404 1119`  
* `122.114.90.3 - - [26/Sep/2018:21:59:09 +0800] "POST //plus/moon.php HTTP/1.1" 301 243`  
* `173.212.192.252 - - [27/Sep/2018:10:49:11 +0800] "GET /scripts/setup.php HTTP/1.1" 301 247`  

æ˜æ˜¾æ˜¯å„ç§è‡ªåŠ¨åŒ–æ‰«æå·¥å…·çš„è¯·æ±‚ï¼Œè¯•äº†ä¸€ä¸‹`cat whoisnian.com-access_log | grep '\.php' | wc -l`ï¼Œemmmmmmï¼Œ36398è¡Œå¸¦`.php`çš„ï¼Œæ¨æµ‹æ‰«æå·¥å…·çš„è®¿é—®å°±å äº†æ—¥å¿—ä¸‰åˆ†ä¹‹ä¸€ä»¥ä¸Šã€‚  

æ¥ä¸‹æ¥æ ¹æ®æˆ‘çš„é“¾æ¥æ ¼å¼ï¼Œæˆ‘åªä¿ç•™äº†å¯¹åšå®¢æ–‡ç« çš„è®¿é—®ä¸”æœåŠ¡å™¨è¿”å›é404/403çŠ¶æ€ç çš„æ—¥å¿—ï¼Œå³ï¼š  
`cat whoisnian.com-access_log | grep -oP '.* - - .* \+0800] "GET /[0-9]{4}/[0-9]{2}/[0-9]{2}/.*" (?!404|403).*' > log1`  
å¥½å˜›ï¼ŒåŸæ¥åå¤šä¸‡è¡Œçš„æ—¥å¿—å°±å‰©7624è¡Œäº†ï¼Œå¯å¤ªçœŸå®äº†ã€‚  

ä½†æ˜¯å‘ç°å…¶ä¸­éƒ¨åˆ†IPåœ°å€ä¼šåœ¨å‡ åç§’çš„é—´éš”å†…å‘é€ä¸¤æ¬¡å†…å®¹ç›¸åŒçš„è¯·æ±‚ï¼Œå†æ¬¡è¿›è¡Œåˆå¹¶ï¼Œå³ï¼š  
`cat log1 | awk '{ print $4,$5,$1,$2,$3,$6,$8,$9,$10,$7 }' | sed 's/\/$//g' | uniq -f 2 | awk '{ print $3,$4,$5,$1,$2,$6,$10,$7,$8,$9 }' > log2`  

å…ˆå°±è¿™æ ·è¿›è¡Œä¸€æ¬¡åˆæ­¥ç­›é€‰å§ï¼Œè¿˜å‰©ä¸‹7430è¡Œã€‚ç†æƒ³æƒ…å†µä¸‹è¿˜å¯ä»¥åªä¿ç•™åŒæ—¶è¯·æ±‚äº†cssæ–‡ä»¶å’Œåšå®¢æ–‡ç« çš„æ—¥å¿—è®°å½•ï¼Œåº”è¯¥å¯ä»¥è¿›ä¸€æ­¥æ’é™¤ä¸€éƒ¨åˆ†çˆ¬è™«ï¼Œä½†æ˜¯æˆ‘æ€•æ—¥å¿—é‚£æ ·ç­›å°±æ²¡å¤šå°‘å‰©çš„äº†ã€‚ã€‚ã€‚  

## ç»Ÿè®¡
### å•ä¸ªIPçš„è®¿é—®æ¬¡æ•°æ’è¡Œï¼š  
`cat log2 | awk '{ print $1 }' | sort | uniq -idc | sort -k1nr | head -n 15`  
å°†æ–‡ä»¶log2çš„å†…å®¹æ¯è¡Œåªä¿ç•™IPï¼Œæ’åºåˆå¹¶ï¼Œå†æŒ‰åˆå¹¶å¾—åˆ°çš„æ¬¡æ•°é™åºï¼Œè¾“å‡ºå‰15è¡Œï¼Œç»“æœä¸ºï¼š  
  
æ¬¡æ•°| IPåœ°å€
----|----
221 | 5.45.207.10
169 | 66.249.70.30
161 | 66.249.70.28
160 | 66.249.66.81
153 | 66.249.70.3
121 | 66.249.66.80
111 | 66.249.66.79
108 | 111.202.100.130
103 | 23.100.232.xxx
83 | 78.46.161.xxx
72 | 159.65.177.xxx
61 | 66.249.66.62
60 | 5.45.207.44
59 | 66.249.66.60
59 | 66.249.66.83

emmmmmmï¼Œ`nslookup 5.45.207.10`å¯ä»¥çœ‹åˆ°`name = 5-45-207-10.spider.yandex.com.`ï¼ŒåŒç†ï¼Œ`66.249.*.*`æ˜¯googleçš„ï¼Œ`111.202.100.130`æ˜¯sougouçš„ï¼Œè®¿é—®æ¬¡æ•°æœ€å¤šçš„æœç„¶æ˜¯çˆ¬è™«ã€‚

### å…·ä½“çš„ç½‘é¡µè®¿é—®é‡æ’è¡Œï¼š  
`cat log2 | awk '{ print $1,$7 }' | sort | uniq | awk '{ print $2 }' | sort | uniq -dc | sort -k1nr | sed 's@+@ @g;s@%@\\x@g' | xargs -0 printf "%b" | head -n 15`  
å°†æ–‡ä»¶log2çš„å†…å®¹æ¯è¡Œåªä¿ç•™IPå’Œè®¿é—®çš„é“¾æ¥ï¼Œæ’åºåˆå¹¶ï¼Œå³ä¸€ä¸ªIPè®¿é—®ä¸€ç¯‡æ–‡ç« åªè®¡ç®—ä¸€æ¬¡ï¼Œå†å°†ç»“æœåªä¿ç•™æ–‡ç« é“¾æ¥ï¼Œæ’åºåˆå¹¶ï¼Œæœ€åæŒ‰åˆå¹¶å¾—åˆ°çš„æ¬¡æ•°é™åºï¼Œè¾“å‡ºå‰15è¡Œï¼Œç»“æœä¸ºï¼š  

æ¬¡æ•°| ç½‘é¡µåœ°å€
----|----
301 | [2018/06/21/ç»™æœåŠ¡å™¨è®¾ç½®åŠ¨æ€motdæ•ˆæœ](/2018/06/21/ç»™æœåŠ¡å™¨è®¾ç½®åŠ¨æ€motdæ•ˆæœ)
250 | [2017/07/23/ArchLinuxå®‰è£…é…ç½®WineQQ](/2017/07/23/ArchLinuxå®‰è£…é…ç½®WineQQ)
235 | [2018/02/09/template-is-undefined](/2018/02/09/template-is-undefined)
230 | [2017/12/27/Apacheåå‘ä»£ç†Google](/2017/12/27/Apacheåå‘ä»£ç†Google)
228 | [2018/03/10/Honor-8-From-EMUI-5-To-Lineage-OS-14.1](/2018/03/10/Honor-8-From-EMUI-5-To-Lineage-OS-14.1)
208 | [2017/08/15/ç½‘æ˜“äº‘éŸ³ä¹ç™½å±](/2017/08/15/ç½‘æ˜“äº‘éŸ³ä¹ç™½å±)
195 | [2017/11/11/i3-WM](/2017/11/11/i3-WM)
181 | [2017/04/07/ArchLinuxä½¿ç”¨è®°å½•](/2017/04/07/ArchLinuxä½¿ç”¨è®°å½•)
181 | [2018/06/13/WPS-Officeä½¿ç”¨è®°å½•](/2018/06/13/WPS-Officeä½¿ç”¨è®°å½•)
156 | [2018/11/18/é€šè¿‡é…·Qå°å·è½¬å‘ä¿¡æ¯](/2018/11/18/é€šè¿‡é…·Qå°å·è½¬å‘ä¿¡æ¯)
137 | [2018/08/23/åœ¨Uç›˜ä¸Šå®‰è£…LFS](/2018/08/23/åœ¨Uç›˜ä¸Šå®‰è£…LFS)
133 | [2017/04/02/ArchLinux-Installation-Guide](/2017/04/02/ArchLinux-Installation-Guide)
124 | [2017/10/26/Raspberryå›¾å½¢ç•Œé¢ä¸‹é¼ æ ‡ç§»åŠ¨ç¼“æ…¢](/2017/10/26/Raspberryå›¾å½¢ç•Œé¢ä¸‹é¼ æ ‡ç§»åŠ¨ç¼“æ…¢)
116 | [2017/04/15/Raspberryå®ç°ç®€å•çš„DNSåŠ«æŒ](/2017/04/15/Raspberryå®ç°ç®€å•çš„DNSåŠ«æŒ)
116 | [2017/06/01/Vultræ­å»ºSSæœåŠ¡](/2017/06/01/Vultræ­å»ºSSæœåŠ¡)

### è®¿é—®è€…IPåˆ†å¸ƒï¼š  
æƒ³è¦åƒå„ç§æµé‡ç»Ÿè®¡æœåŠ¡é‚£æ ·ç”Ÿæˆä¸€ä¸ªè®¿å®¢åœ°å›¾ï¼Œåœ¨ç½‘ä¸Šæœåˆ°äº†å¥½å¤šéƒ½æ˜¯è®©ä½¿ç”¨å®ƒçš„ç»Ÿè®¡æœåŠ¡ï¼Œå®ƒç»™ä½ è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œè‡ªå·±æ ¹æ®æ”¶é›†åˆ°çš„ä¿¡æ¯åˆ¶ä½œè®¿å®¢åœ°å›¾çš„ç›¸å…³å†…å®¹å´å¾ˆå°‘ã€‚  

é—®äº†ä¸€ä¸‹ç†Ÿæ‚‰å‰ç«¯çš„åŒå­¦ï¼ŒåŒå­¦æ¨èäº†[ECharts](https://echarts.baidu.com/)ï¼Œçœ‹äº†ä¸€ä¸‹å®˜ç½‘ç»™å‡ºçš„æ ·ä¾‹å¾ˆä¸é”™ï¼Œäºæ˜¯ç…§ç€æ”¹äº†ä¸€ä¸ªã€‚é‚£ä¹ˆæ¥ä¸‹æ¥å°±éœ€è¦å°†IPåœ°å€è½¬æ¢æˆåœ°åŒºï¼Œå†æ”¹æˆ`{name: 'xxxxx',value: xxx}`çš„æ ¼å¼ã€‚  

å…ˆå°è¯•äº†`geoiplookup`ï¼Œå‘ç°éƒ¨åˆ†IPåœ°å€è¯†åˆ«ä¸å‡ºæ¥ï¼Œè¿˜æœ‰éƒ¨åˆ†â€œäºšå¤ªåœ°åŒºâ€è¿™æ ·æŒ‡å‘ä¸æ˜æ˜¾çš„ç»“æœã€‚æŸ¥çœ‹`/usr/share/GeoIP/`ç›®å½•ä¸‹çš„æ•°æ®åº“ï¼Œå‘ç°é™¤äº†`geoiplookup`ä½¿ç”¨çš„`.dat`ä¹‹å¤–è¿˜æœ‰å¦ä¸€ç§`.mmdb`ï¼Œå°±åˆåœ¨æºé‡Œæ‰¾åˆ°äº†`mmdblookup`è¿™ä¸ªå·¥å…·ï¼Œè¯•ç”¨äº†ä¸€ä¸‹ï¼Œæ„Ÿè§‰æ•ˆæœè¿˜å¯ä»¥ï¼Œäºæ˜¯ç”¨äº†è¿™ä¸ªã€‚  

å°†æ–‡ä»¶log2çš„å†…å®¹åªä¿ç•™IPåœ°å€ï¼Œå¹¶å°†ç›¸åŒçš„IPåˆå¹¶ï¼š  
`cat log2 | awk '{ print $1 }' | sort | uniq > log3`  
ç„¶åä½¿ç”¨è„šæœ¬æŒ‰è¡Œå¤„ç†ï¼š`./geo.sh log3 > log4`ï¼Œè„šæœ¬å¦‚ä¸‹ï¼Œæ³¨æ„è¦æ‰‹åŠ¨æŒ‡å®šmmdbæ–‡ä»¶çš„ä½ç½®ã€‚  
```bash
#!/bin/bash
# geo.sh
while read line; do
  country=`mmdblookup -f /usr/share/GeoIP/GeoLite2-Country.mmdb -i "$line" country names en 2>/dev/null`
  if [ $? -ne 0 ]; then
    country=`mmdblookup -f /usr/share/GeoIP/GeoLite2-Country.mmdb -i "$line" registered_country names en 2>/dev/null`
  fi
  echo $country | awk -F '"' '{ print $2 }'
done < $1
```
å¾—åˆ°çš„åˆ—è¡¨è¿˜éœ€è¦ä¿®æ”¹ï¼Œå› ä¸º`ECharts`ä¸­ä½¿ç”¨çš„åœ°å›¾éœ€è¦ä»¥å›½å®¶ä¸ºåˆ’åˆ†ï¼Œè€Œ`mmdblookup`ç›´æ¥å¾—åˆ°åˆ—è¡¨æ˜¯ä»¥åœ°åŒºä¸ºåˆ’åˆ†çš„ï¼Œä¸¤è€…ä¹‹é—´è¿˜æœ‰éƒ¨åˆ†åç§°ä¸ä¸€è‡´çš„æƒ…å†µï¼Œä¿®æ”¹å¦‚ä¸‹ï¼š  
```bash
sed -i 's/^Hong\ Kong$/China/g;
        s/^Macao$/China/g;
        s/^Taiwan$/China/g;
        s/^South\ Korea$/Korea/g;
        s/^Czechia$/Czech\ Rep\./;' log4
```
å°†å¾—åˆ°çš„å›½å®¶åˆ—è¡¨æ’åºåˆå¹¶ï¼Œå¹¶è½¬æ¢ä¸º`ECharts`éœ€è¦çš„å½¢å¼ï¼š  
`cat log4 | sort | uniq -c | sort -k1nr | awk '{printf"{name: '\''%s", $2; for(i=3;i<=NF;i++){printf" %s", $i}; printf"'\'',value: %s},\n", $1;}'`  
å¾—åˆ°ï¼š  
```
{name: 'China',value: 1397},
{name: 'United States',value: 720},
{name: 'France',value: 77},
{name: 'Japan',value: 35},
{name: 'Russia',value: 28},
{name: 'Czech Rep.',value: 24},
{name: 'Canada',value: 16},
{name: 'Germany',value: 16},
{name: 'Singapore',value: 11},
{name: 'United Kingdom',value: 7},
{name: 'Malaysia',value: 6},
{name: 'Vietnam',value: 6},
{name: 'Ukraine',value: 5},
{name: 'Netherlands',value: 4},
{name: 'Australia',value: 3},
{name: 'India',value: 3},
{name: 'Cambodia',value: 2},
{name: 'Korea',value: 2},
{name: 'Poland',value: 2},
{name: 'Thailand',value: 2},
{name: 'Algeria',value: 1},
{name: 'Hungary',value: 1},
{name: 'Italy',value: 1},
{name: 'Malawi',value: 1},
{name: 'Norway',value: 1},
{name: 'Philippines',value: 1},
{name: 'Slovakia',value: 1},
{name: 'Switzerland',value: 1},
```
å°†æ•°æ®å¡«å…¥æ”¹å†™çš„`ECharts`æ ·ä¾‹ä¸­ï¼Œå¾—åˆ°ï¼š  

```html
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>ECharts</title>
    <script src="https://cdn.bootcss.com/echarts/4.2.1/echarts.min.js"></script>
    <script src="https://echarts-maps.github.io/echarts-countries-js/echarts-countries-js/world.js"></script>
</head>
<body>
    <div id="main" style="width:900px;height:500px;"></div>
    <script type="text/javascript">
        var myChart = echarts.init(document.getElementById('main'));

        var option = {
            title: {
                text: 'è®¿å®¢åœ°å›¾'
            },
            tooltip: {
                trigger: 'item'
            },
            visualMap: {
                min: 0,
                max: 300,
                left: 'left',
                top: 'bottom',
                text:['å¤š','å°‘']
            },
            toolbox: {
                show: true,
                orient : 'horizontal',
                left: 'right',
                top: 'bottom',
                showTitle: false,
                feature : {
                    restore : {show: true},
                    saveAsImage : {show: true}
                }
            },
            series : [
                {
                    name: 'visitors',
                    type: 'map',
                    mapType: 'world',
                    roam: true,
                    scaleLimit: {
                        min: 1,
                        max: 10
                    },   
                    data:[
                        {name: 'China',value: 1397},
                        {name: 'United States',value: 720},
                        {name: 'France',value: 77},
                        {name: 'Japan',value: 35},
                        {name: 'Russia',value: 28},
                        {name: 'Czech Rep.',value: 24},
                        {name: 'Canada',value: 16},
                        {name: 'Germany',value: 16},
                        {name: 'Singapore',value: 11},
                        {name: 'United Kingdom',value: 7},
                        {name: 'Malaysia',value: 6},
                        {name: 'Vietnam',value: 6},
                        {name: 'Ukraine',value: 5},
                        {name: 'Netherlands',value: 4},
                        {name: 'Australia',value: 3},
                        {name: 'India',value: 3},
                        {name: 'Cambodia',value: 2},
                        {name: 'Korea',value: 2},
                        {name: 'Poland',value: 2},
                        {name: 'Thailand',value: 2},
                        {name: 'Algeria',value: 1},
                        {name: 'Hungary',value: 1},
                        {name: 'Italy',value: 1},
                        {name: 'Malawi',value: 1},
                        {name: 'Norway',value: 1},
                        {name: 'Philippines',value: 1},
                        {name: 'Slovakia',value: 1},
                        {name: 'Switzerland',value: 1}
                    ]
                }
            ]
        };

        myChart.setOption(option);
    </script>
</body>
</html>

```
ç”¨æµè§ˆå™¨æ‰“å¼€å°±å¯ä»¥çœ‹åˆ°è®¿å®¢åœ°å›¾ï¼Œè¿˜å¯ä»¥ç‚¹å‡»ä¿å­˜æŒ‰é’®ç›´æ¥ä¿å­˜ä¸ºpngã€‚  
![vistor_map](/public/image/visitor_map.webp)
