---
layout: post
title: æ•´ç†httpdæ—¥å¿—ä¸­çš„ä¿¡æ¯
categories: Server
---

> å› ä¸ºæ²¡æœ‰ä½¿ç”¨Google Analyticsä¸€ç±»çš„æµé‡ç»Ÿè®¡æœåŠ¡ï¼Œæ‰€ä»¥æˆ‘å¹¶ä¸æ¸…æ¥šè‡ªå·±åšå®¢çš„å…·ä½“è®¿é—®æƒ…å†µï¼Œçªç„¶æƒ³å»äº†è§£ä¸€ä¸‹ï¼Œäºæ˜¯å°±æƒ³åˆ°äº†å¯ä»¥åˆ†æhttpdæ—¥å¿—ä¸­çš„ä¿¡æ¯ã€‚

<!-- more -->

## å‡†å¤‡
* ä»æœåŠ¡å™¨ä¸Šä¸‹è½½æ—¥å¿—ã€‚  
  ç›´æ¥sftpåˆ°æŒ‡å®šçš„æ—¥å¿—æ–‡ä»¶å¤¹ä¸­æŠŠ`whoisnian.com-access_log`ä¸‹è½½ä¸‹æ¥å³å¯ã€‚  
* é€‰æ‹©è¦ä½¿ç”¨çš„å·¥å…·ã€‚  
  æƒ³é¡ºä¾¿ç†Ÿæ‚‰ä¸€ä¸‹SHELLæ“ä½œï¼Œå°±ç›´æ¥ç”¨Linuxçš„å„ç§å‘½ä»¤æ¥å¤„ç†äº†ã€‚  

## ç›®æ ‡  
å…ˆçœ‹çœ‹æ—¥å¿—é‡Œæœ‰ä»€ä¹ˆï¼š  
`10.10.10.10 - - [08/May/2019:17:17:33 +0800] "GET / HTTP/1.1" 200 9584`  
æˆ‘çš„æ—¥å¿—é‡Œæ¯ä¸€è¡Œéƒ½æ˜¯è¿™æ ·çš„æ ¼å¼ï¼Œåœ¨[Apacheå®˜æ–¹æ–‡æ¡£](https://httpd.apache.org/docs/current/mod/mod_log_config.html)ä¸­è¢«å«åš`Common Log Format (CLF)`ï¼Œå…·ä½“å«ä¹‰ä¸ºï¼š  
`è¿œç«¯ä¸»æœºåœ°å€ è¿œç«¯ç™»å½•å è¿œç¨‹ç”¨æˆ·å æ—¶é—´ è¯·æ±‚çš„ç¬¬ä¸€è¡Œ çŠ¶æ€ç  ä¼ é€çš„ä¸åŒ…å«HTTPå¤´çš„å­—èŠ‚æ•°`  
ä¹Ÿå°±æ˜¯è¯´ï¼Œä»æ—¥å¿—ä¸­å¯ä»¥è·å–åˆ°çš„æœ‰ç”¨ä¿¡æ¯åŒ…æ‹¬è®¿é—®è€…çš„IPï¼Œè®¿é—®æ—¶é—´ï¼Œè¯·æ±‚çš„å…·ä½“ç½‘å€ï¼Œè¯·æ±‚ç”¨çš„åè®®ï¼ŒæœåŠ¡å™¨å“åº”ç ã€‚æ‰€ä»¥ç»Ÿè®¡ä»¥ä¸‹å‡ ç‚¹æ˜¯å¯è¡Œçš„ï¼š  
* å•ä¸ªIPçš„è®¿é—®æ¬¡æ•°æ’è¡Œ
* å…·ä½“çš„ç½‘é¡µè®¿é—®é‡æ’è¡Œ
* è®¿é—®è€…IPåˆ†å¸ƒå›¾

å¯æƒœä¹‹å‰æœåŠ¡å™¨çš„ä¸€æ¬¡æ»šæŒ‚ï¼Œå¯¼è‡´ä¸‹è½½åˆ°çš„æ—¥å¿—åªæœ‰2018å¹´9æœˆä»½ä¹‹åçš„ï¼ŒçŒœæµ‹æœ€ç»ˆå¾—åˆ°çš„ç»“æœä¼šæ¯”è¾ƒå¯’ç¢œã€‚ğŸ˜­  

## ç­›é€‰
ç›´æ¥æ‰“å¼€æ—¥å¿—æ–‡ä»¶ï¼Œçº¦åå››ä¸‡è¡Œï¼Œä½†å¾ˆæ˜æ˜¾ï¼Œé‡Œé¢æœ‰è®¸å¤šæ— æ•ˆè¯·æ±‚ã€‚ä¾‹å¦‚ï¼š  
* `61.176.222.170 - - [20/Sep/2018:04:49:42 +0800] "GET http://47.99.121.32:39169/Ip/Up?Ip=45.77.221.110&Port=80&Check=30&Order=61.176.222.170 HTTP/1.1" 404 1010`  
* `193.112.137.18 - - [20/Sep/2018:06:17:47 +0800] "POST /cainiao.php HTTP/1.1" 404 16`  
* `221.231.6.240 - - [26/Sep/2018:03:32:52 +0800] "GET /Web/FCKeditor/fckeditor.js HTTP/1.1" 404 1119`  
* `122.114.90.3 - - [26/Sep/2018:21:59:09 +0800] "POST //plus/moon.php HTTP/1.1" 301 243`  
* `173.212.192.252 - - [27/Sep/2018:10:49:11 +0800] "GET /scripts/setup.php HTTP/1.1" 301 247`  

æ˜æ˜¾æ˜¯å„ç§è‡ªåŠ¨åŒ–æ‰«æå·¥å…·çš„è¯·æ±‚ï¼Œè¯•äº†ä¸€ä¸‹`cat whoisnian.com-access_log | grep '\.php' | wc -l`ï¼Œemmmmmmï¼Œ36398è¡Œå¸¦`.php`çš„ï¼Œæ¨æµ‹æ‰«æå·¥å…·çš„è®¿é—®å°±å äº†æ—¥å¿—ä¸‰åˆ†ä¹‹ä¸€ä»¥ä¸Šã€‚  

æ¥ä¸‹æ¥æ ¹æ®æˆ‘çš„é“¾æ¥æ ¼å¼ï¼Œæˆ‘åªä¿ç•™äº†å¯¹åšå®¢æ–‡ç« çš„è®¿é—®ä¸”æœåŠ¡å™¨è¿”å›é404çŠ¶æ€ç çš„æ—¥å¿—ï¼Œå³ï¼š  
`cat whoisnian.com-access_log | grep -oP '.* - - .* \+0800] "GET /[0-9]{4}/[0-9]{2}/[0-9]{2}/.*" (?!404).*' > log1`  
å¥½å˜›ï¼ŒåŸæ¥åå¤šä¸‡è¡Œçš„æ—¥å¿—å°±å‰©7625è¡Œäº†ï¼Œå¯å¤ªçœŸå®äº†ã€‚  

ä½†æ˜¯å‘ç°å…¶ä¸­éƒ¨åˆ†IPåœ°å€ä¼šåœ¨å‡ åç§’çš„é—´éš”å†…å‘é€ä¸¤æ¬¡å†…å®¹ç›¸åŒçš„è¯·æ±‚ï¼Œå†æ¬¡è¿›è¡Œåˆå¹¶ï¼Œå³ï¼š  
`cat log1 | awk '{ print $4,$5,$1,$2,$3,$6,$8,$9,$10,$7 }' | sed 's/\/$//g' | uniq -f 2 | awk '{ print $3,$4,$5,$1,$2,$6,$10,$7,$8,$9 }' > log2`  

å…ˆå°±è¿™æ ·è¿›è¡Œä¸€æ¬¡åˆæ­¥ç­›é€‰å§ï¼Œç†æƒ³æƒ…å†µä¸‹è¿˜å¯ä»¥åªä¿ç•™åŒæ—¶è¯·æ±‚äº†cssæ–‡ä»¶å’Œåšå®¢æ–‡ç« çš„æ—¥å¿—ï¼Œåº”è¯¥å¯ä»¥è¿›ä¸€æ­¥æ’é™¤ä¸€éƒ¨åˆ†çˆ¬è™«ã€‚  

## ç»Ÿè®¡
* å•ä¸ªIPçš„è®¿é—®æ¬¡æ•°æ’è¡Œï¼š  
  `cat log2 | awk '{ print $1 }' | sort | uniq -idc | sort -k1nr | head -n 15`  
  å°†æ–‡ä»¶log1çš„å†…å®¹æ¯è¡Œåªä¿ç•™IPï¼Œæ’åºåˆå¹¶ï¼Œå†æŒ‰åˆå¹¶å¾—åˆ°çš„æ¬¡æ•°é™åºï¼Œè¾“å‡ºå‰15è¡Œï¼Œç»“æœä¸ºï¼š  
  
  æ¬¡æ•°| IPåœ°å€
  ----|----
  221 | 5.45.207.10
  169 | 66.249.70.30
  161 | 66.249.70.28
  160 | 66.249.66.81
  153 | 66.249.70.3
  121 | 66.249.66.80
  111 | 66.249.66.79
  108 | 111.202.100.130
  103 | 23.100.232.xxx
  83 | 78.46.161.xxx
  72 | 159.65.177.xxx
  61 | 66.249.66.62
  60 | 5.45.207.44
  59 | 66.249.66.60
  59 | 66.249.66.83

  emmmmmmï¼Œ`nslookup 5.45.207.10`å¯ä»¥çœ‹åˆ°`name = 5-45-207-10.spider.yandex.com.`ï¼ŒåŒç†ï¼Œ`66.249.*.*`æ˜¯googleçš„ï¼Œ`111.202.100.130`æ˜¯sougouçš„ï¼Œçœ‹èµ·æ¥å˜æˆçˆ¬è™«çˆ¬å–æ¬¡æ•°æ’åºäº†ã€‚ã€‚ã€‚

* å…·ä½“çš„ç½‘é¡µè®¿é—®é‡æ’è¡Œï¼š  
  `cat log2 | awk '{ print $1,$7 }' | sort | uniq | awk '{ print $2 }' | sort | uniq -idc | sort -k1nr | sed 's@+@ @g;s@%@\\x@g' | xargs -0 printf "%b" | head -n 15`  
  å°†æ–‡ä»¶log1çš„å†…å®¹æ¯è¡Œåªä¿ç•™IPå’Œè®¿é—®çš„é“¾æ¥ï¼Œæ’åºåˆå¹¶ï¼Œå³ä¸€ä¸ªIPè®¿é—®ä¸€ç¯‡æ–‡ç« åªè®¡ç®—ä¸€æ¬¡ï¼Œå†å°†ç»“æœåªä¿ç•™æ–‡ç« é“¾æ¥ï¼Œæ’åºåˆå¹¶ï¼Œæœ€åæŒ‰åˆå¹¶å¾—åˆ°çš„æ¬¡æ•°é™åºï¼Œè¾“å‡ºå‰15è¡Œï¼Œç»“æœä¸ºï¼š  

  æ¬¡æ•°| ç½‘é¡µåœ°å€
  ----|----
  316 | /2018/06/21/ç»™æœåŠ¡å™¨è®¾ç½®åŠ¨æ€motdæ•ˆæœ
  252 | /2017/07/23/ArchLinuxå®‰è£…é…ç½®WineQQ
  246 | /2017/12/27/apacheåå‘ä»£ç†google
  235 | /2018/02/09/template-is-undefined
  229 | /2018/03/10/honor-8-from-emui-5-to-lineage-os-14.1
  217 | /2017/08/15/ç½‘æ˜“äº‘éŸ³ä¹ç™½å±
  195 | /2017/11/11/i3-WM
  184 | /2018/06/13/wps-officeä½¿ç”¨è®°å½•
  182 | /2017/04/07/ArchLinuxä½¿ç”¨è®°å½•
  165 | /2018/11/18/é€šè¿‡é…·Qå°å·è½¬å‘ä¿¡æ¯
  140 | /2018/08/23/åœ¨uç›˜ä¸Šå®‰è£…lfs
  133 | /2017/04/02/ArchLinux-Installation-Guide
  124 | /2017/10/26/Raspberryå›¾å½¢ç•Œé¢ä¸‹é¼ æ ‡ç§»åŠ¨ç¼“æ…¢
  120 | /2017/04/15/raspberryå®ç°ç®€å•çš„dnsåŠ«æŒ
  120 | /2017/06/01/Vultræ­å»ºSSæœåŠ¡

* è®¿é—®è€…IPåˆ†å¸ƒ
  æƒ³è¦åƒå„ç§æµé‡ç»Ÿè®¡æœåŠ¡é‚£æ ·ç”Ÿæˆä¸€ä¸ªè®¿å®¢åœ°å›¾ï¼Œåœ¨ç½‘ä¸Šæœåˆ°äº†å¥½å¤šéƒ½æ˜¯è®©ä½¿ç”¨å®ƒçš„ç»Ÿè®¡æœåŠ¡ï¼Œå®ƒç»™ä½ è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œè‡ªå·±æ ¹æ®æ”¶é›†åˆ°çš„ä¿¡æ¯åˆ¶ä½œçš„å´å¾ˆå°‘ã€‚  
  è¯·æ•™åŒå­¦ï¼ŒåŒå­¦æ¨èäº†ä½¿ç”¨[ECharts](https://echarts.baidu.com/)ï¼Œçœ‹äº†ä¸€ä¸‹å¾ˆä¸é”™ï¼Œäºæ˜¯è¯•ç€ç…§ç€æ ·ä¾‹éšä¾¿å†™äº†ä¸€ä¸ªã€‚é‚£ä¹ˆæ¥ä¸‹æ¥å°±éœ€è¦å°†IPåœ°å€è½¬æ¢æˆå›½å®¶ï¼Œå†æ”¹æˆ`{name: 'xxxxx',value: xxx}`çš„æ ¼å¼ã€‚  
  è¿™é‡Œå¯ä»¥ä½¿ç”¨`geoiplookup`ï¼Œ

{% highlight html %}
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>ECharts</title>
    <script src="https://cdn.bootcss.com/echarts/4.2.1/echarts.min.js"></script>
    <script src="https://echarts-maps.github.io/echarts-countries-js/echarts-countries-js/world.js"></script>
</head>
<body>
    <div id="main" style="width:800px;height:500px;"></div>
    <script type="text/javascript">
        var myChart = echarts.init(document.getElementById('main'));

        var option = {
            title: {
                text: 'è®¿å®¢åœ°å›¾'
            },
            tooltip: {
                trigger: 'item'
            },
            visualMap: {
                min: 0,
                max: 500,
                left: 'left',
                top: 'bottom',
                text:['å¤š','å°‘']
            },
            toolbox: {
                show: true,
                orient : 'vertical',
                left: 'right',
                top: 'center',
                feature : {
                    mark : {show: true},
                    dataView : {show: true, readOnly: true},
                    restore : {show: true},
                    saveAsImage : {show: true}
                }
            },
            series : [
                {
                    name: 'visitors',
                    type: 'map',
                    mapType: 'world',
                    roam: false,
                    label: {
                        normal: {
                            show: false
                        },
                        emphasis: {
                            show: true
                        }
                    },
                    data:[
                        {name: 'China',value: 400},
                        {name: 'United States',value: 200}
                    ]
                }
            ]
        };

        myChart.setOption(option);
    </script>
</body>
</html>
{% endhighlight %}
